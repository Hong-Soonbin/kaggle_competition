# 시계열 판매량 예측 회귀문제    (70128, 6), (17520, 5)
-------------------------------------------------------------------------------------------------------------------------
## 캐글 진행과정   
### 1. 피처 요약표 사용   

### 2. 분포, 고유값 탐색

### 3. 시간에 따른 타겟값 변화 시각화
```python
  weekly_df = train.groupby(["country","store", "product", pd.Grouper(key="date", freq="W")])["num_sold"].sum().rename("num_sold").reset_index()
monthly_df = train.groupby(["country","store", "product", pd.Grouper(key="date", freq="MS")])["num_sold"].sum().rename("num_sold").reset_index()
```
  - pd.Grouper(key="date", feq="")사용 덕분에 핸들링이 편했다.  
  product, country, store를 subplot, hue, style로 쪼개서 시각화했더니 보기좋았다.

### 4. 피처의 비중을 타겟값에 나누어서 비율을 확인   
  - store피처는 고유값이 2개로 mart와 rama가 있었다.   
  mart와 rama의 비율은 0.742:0.257이었는데 2.88:1로 나타낼 수 있고   
  mart:rama = 2.88:1   
  mart = 2.88*rama   
  이렇게 핸들링해서 시계열 시각화를 통해서 추세를 비교할수있다.   
  비교했더니 mart와 rama는 거의 동일하게 움직였다.
  
   - 같은 방법으로 country별 store별 비중을통해서 추세를 확인했더니 모두 거의 같은 추세를 보였다.
    특이사항이 있다면 2021년1월부터 알수없는 일로 인해 모든 국가별 판매량이 동일해지는 현상이 있었다.  

### 5. product피처 탐색
  product피처 x=date y=target으로 시각화를 했더니 주기성이 있어보이지만 명확하지 않았다.   
  그래서 상품별 판매량 추이 / 각 상품별 판매량 비중으로 핸들링을 하고 시각화를 했더니   
  명확한 주기가 있음을 확인했다.   

### 6. df.dt. 피처엔지니어링, 시각화
  - df.dt.month, df.dt.dayofweek, df.dt.dayofyear 를 통해서 월별, 주별, 일별 피처를 생성해 시각화   
  연초,연말과 특정날(공휴일)에 민감함을 보인다.   

### 7. Lasso, Ridge 모델의 특징과 차이점   
  - RSS =  ∑ni=1(yi−(β0+∑pj=1βjxij))2 
  RSS =  ∑(실제Y−(Y예측값))2 

  - Lasso = RSS +  λ∑pj=1|βj| 
  Lasso = RSS +  λ 독립변수의 기울기

  - Ridge = RSS +  λ∑pj=1∣∣β2j∣∣ 
  따라서 Lasso는 L1규제를 통해서 독립변수의 가중치를 작게 만들어 일반화된 모형을 찾는다.(독립변수들의   기울기의 합이 0에 수렴)
  보통 일반선형모델보다 Lasso가 더 점수가 높다면 독립변수의 수를 줄이는게 좋다.
  가중치들이 0이 되게 함으로써 그에 해당하는 특성들을 제외해준다. 결과적으로 모델에서 가장 중요한 특성   이 무엇인지 알게되는 등 모델 해석력이 좋아진다.

  - ridge lasso를 쓰는 이유
  일반적인 선형모델에서 독립변수간 선형종속관계(다중공산성)가 존재한다면 역행렬이 존재하지않아 계산할     수 없게 된다.
  ridge는 임의로 대각행렬에 작은 값을 추가하여 역행렬을 구할 수 있게 만든다.

  - Ridge와 Lasso는 차이점 또한 존재한다. Ridge와 Lasso의 가장 큰 차이는 Ridge는 계수를 0에 근사하도록   축소하나, Lasso는 계수를 완전하게 0으로 축소시킨다. 그렇기에 Ridge의 경우 입력변수가 전반적으로 비슷   한 수준으로 출력변수에 영향을 미치는 경우 사용하고, Lasso의 경우 출력변수에 미치는 입력변수의 영향     력 편차가 큰 경우에 사용한다.

  - 보통은 성능이 Ridge와 Elastic-Net이 좋다고 하나, 절대적이지 않다고 한다. 그렇기에 변수선택법이든,     계수축소법이든 모형을 단순화 시킬때 여러 방면으로 확인해보는 작업이 필요하다.   
### 8. 피처엔지니어링  
  - 12개월을 sin cos으로 주기성, 일, 요일, [국가별 공휴일, 연말, 연초, 국가별 부활절] 매핑  
### 9. 모델학습
  - LinearRegression
  - Ridge
  - Lasso
  - ElasticNet
### 10. 성능개선
  - 하이퍼 파라미터 수정 GridSearchCV
  - Kfold 
  - ensemble
  - 예측값에 19,20,21년도 타겟값 비중 곱해주기

-------------------------------------------------------------------------------------------------------------------------
## 키 포인트 아이디어  
### 코로나 기간 핸들링
  - 코로나기간 동안 국가별 판매량이 같아지는 현상이 발견되었다.  
    따라서 다른 기간으로 코로나기간을 예측해서 대체값을 넣었다.
### 연말, 국가별 공휴일 부활절 맵핑
  - feature importance에서 12월28일∼12월30일 일요일 등이 가장 중요한 피처로 나왔다.
-------------------------------------------------------------------------------------------------------------------------
회고
-------------------------------------------------------------------------------------------------------------------------
두번째 캐글 도전으로 playground 대회에 참가했는데 346/1383 등을 했다.<br>
시계열에 익숙하지않아 다양한 시계열 기법에 대해서 공부하는 좋은 기회였다.  
창의적인 피처엔지니어링과 지금 상황에 효율적인 모델을 찾기에 가장 많은 시간을 투자했다.  

아래 노트북을 통해서 시계열 관련 정보를 따로 내 노트북에 정리할 예정.
https://www.kaggle.com/code/adaubas/tps-sep-2022-10th-place-solution-ridge-glm/notebook?scriptVersionId=106679581
